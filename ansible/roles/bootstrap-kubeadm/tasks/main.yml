---
# tasks file for bootstrap-kubeadm
- name: "Iniciar kubeadm"
  ansible.builtin.command:
    cmd: kubeadm init --pod-network-cidr={{ cidr }}/16 --apiserver-advertise-address={{ ansible_facts['enp0s8']['ipv4']['address'] }} --ignore-preflight-errors=all
- name: Armazenar comando join
  ansible.builtin.shell:
    cmd: kubeadm token create --print-join-command > /vagrant/ansible/roles/cluster-join/files/kubeadmjoin
- name: "Criar diretório .kube"
  ansible.builtin.file:
    path: /home/vagrant/.kube
    state: directory
- name: "Copiar config do k8s para todos os usuários"
  ansible.builtin.copy:
    src: /etc/kubernetes/admin.conf
    dest: /home/vagrant/.kube/config
    remote_src: yes
- name: Copiar kubeconfig para /vagrant - diretório compartilhado
  ansible.builtin.copy:
    src: /home/vagrant/.kube/config
    dest: /vagrant/ansible/roles/cluster-join/files/config
    remote_src: true
- name: "Copiar resources do tigera-operator"
  ansible.builtin.copy:
    src: tigera-operator.yaml
    dest: /home/vagrant/tigera-operator.yaml
- name: "Copiar resources do calico"
  ansible.builtin.copy:
    src: custom-resources.yaml
    dest: /home/vagrant/custom-resources.yaml
- name: "Ajustar cidr calico"    
  ansible.builtin.command:
    cmd: sed -i 's/192.168.0.0/{{ cidr }}/' custom-resources.yaml
- name: "Ajustar ip do worker node no kubelet"
  lineinfile:
    line: "Environment=\"KUBELET_EXTRA_ARGS=--node-ip={{ ansible_facts['enp0s8']['ipv4']['address'] }}\""
    path: /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
    state: present
    insertafter: '^\[Service'
- name: "Reiniciar kubelet"
  ansible.builtin.systemd_service:
    name: kubelet
    daemon_reload: true
    state: restarted
- name: "Aplicar tigera operator" 
  become: false
  ansible.builtin.command:
    cmd: kubectl create -f tigera-operator.yaml
- name: "Aplicar calico custom resources" 
  become: false
  ansible.builtin.command:
    cmd: kubectl create -f custom-resources.yaml